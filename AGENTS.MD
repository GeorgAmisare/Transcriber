# Правила

- Следовать PEP8 и принципам чистой архитектуры.
- Писать человеко-понятный код – над кодом проекта будут работать люди.
- Использовать понятные имена переменных, функций и классов.
- Функции не более 30 строчек, классыне более 300 строчек, модули не более 500 строчек.
- Оставлять докстринги и комментарии:
  - Кратко описывать входы, выходы и назначение функций.
  - Объяснять сложные алгоритмы.
  - Все комментарии — на русском языке.
- Соблюдать четкую и логичную структуру файлов и папок в проекте.
- Соблюдать управление сложностью кода:
  - DRY — избегать дублирования кода.
  - KISS — выбирать самое простое решение.
  - YAGNI — не реализовывать функционал «на будущее».
  - Слабая связность — модули должны быть слабо связаны, но внутренне целостны.
  - Код-ревью — проверять соответствие архитектуре, плану и правилам.
- Писать подробные Pull Request на русском языке.
- Вся функциональность должна быть покрыта тестами, при добавлении новой функциональности надо проверить, не требуется ли актуализировать или добавить тесты.
- При добавлении или изменении функциональности надо проверить, не требуется ли обновить файл README.MD.
- Если Агент обнаруживает противоречие в задаче или в файле AGENTS.MD, он должен сообщить об этом в результатах задачи.

# Общее описание

Транскрибатор используется пользователем, чтобы получать текстовый файл с расшифровкой встречи из записи встречи.

Контекст - данный текстовый файл потом используется пользователем в GPT для формирования фоллоуапа встречи, но это уже функционал вне рамок данной программы.

Приложение имеет минимальный интерфейс и позволяет только загрузить в него запись встречи методом drag-n-drop, автоматически запуская обработку данных.

Программа требует подключения к интернету.

# Пользовательский сценарий

1. Пользователь подготавливает файл с записью встречи в рамках разрешенной длительности и формата файла.
2. Пользователь открывает программу “транскрибатор”, которая открывается как небольшой окно, где есть надпись “Загрузите файл [перечисляются требования к файлу]”.
3. Пользователь, используя компьютерную мышь, методом drag-n-drop перетаскивает исходный файл в окно программы.
4. Программа начинает обработку файлов, сопровождая процесс обозначением статустов и этапов обработки в интерфейсе программы.
5. Когда обработка заканчивается, появляется надпись “файл [название исходного файла] успешно обработан, результат находится в [путь к результату и название файла с расшифровкой]. Если требуется новая обработка, перетащите новый файл”.
6. Рядом с исходным файлом появляется текстовый файл с расшифровкой.

# Интерфейс

- Минимальный интерфейс
- Небольшое окно
- Нет кнопок управления и конфигурации, только статусы и инструкции по этапам
- Есть три основных этапа:
  - Ожидание первого файла
  - Процесс обработки
  - Сообщение о результате
- Начало обработки автоматически начинается при перетаскивании в окно исходного файла
- Любые ошибки или неожиданные сценарии выводятся в интерфейсе текстовой надписью

# Входные данные

- Входными данными является исходный файл записи встречи.
- Исходный файл может быть как видео или аудио, допустимые форматы: MP4 (h.264 + AAC), MOV (Apple QuickTime), AVI, MKV (Matroska), WMV (Windows Media Video), WebM, FLV, M4V, TS/MTS (камкордеры), MP3, WAV (PCM), AAC (M4A контейнер), WMA, OGG / OGA (Vorbis/Opus), FLAC, AMR (часто в мобильных записях), AIFF / AIFC, Opus (в WebM/OGG), CAF (Apple Core Audio Format).
- Ограничение на длительность исходного файла – 90 минут.
- Ограничение на размер - не более 2 гигабайт.
- При непрохождении любых ограничений, пользователь должен быть об этом проинформирован в интерфейсе.

# Обработка данных

1. Если это видео - извлечь звук.
2. Нормализовать аудио.
3. Провести транскрибацию.
4. Провести диаризацию (определение спикеров).
5. Объединить результаты транскрибации и диаризации в единый текст с разметкой, где указано, кто и что говорил.
6. Удалить промежуточные файлы (чистая транскрибация, чистая диаризациа), оставив только конечный текстовый файл.

# Выходные данные

- На выходе программа создает текстовый файл с расширением .txt (кодировка UTF-8).
- Наименование текстового файла в формате: “[Название исходного файла]+\_transcript”
- Каждая реплика в текстовом файле оформляется в отдельной строке:
  - Формат: [Время начала — Время окончания] Спикер N: Текст.
  - Пример: [00:01:23 — 00:01:45] Спикер 2: Добрый день, начинаем встречу.
- Итоговый файл должен быть в кодировке UTF-8.

# Архитектура

## Общая структура программы

- **GUI (PyQt):** отвечает за окно программы, drag-n-drop файлов и отображение статусов.
- **Модуль обработки медиа (FFmpeg):** извлечение аудио из видео, нормализация.
- **Модуль транскрибации (Whisper):** преобразование аудио в текст.
- **Модуль диаризации (pyannote.audio):** определение спикеров и разметка текста.
- **Модуль постобработки:** объединение транскрипции и диаризации в итоговый файл.
- **Модуль экспорта:** сохранение результата в .txt.

## Технологический стек

- Язык реализации: **Python**.
- GUI: **PyQt5** или **Tkinter**.
- Работа с медиа: **FFmpeg**.
- ASR: **Whisper (OpenAI)**.
- Диаризация: **pyannote.audio**.
- Сборка в exe: **PyInstaller**.

## Взаимодействие компонентов

1. Пользователь перетаскивает файл в GUI.
2. GUI передаёт путь к файлу модулю обработки медиа.
3. Обработанный аудиофайл поступает в модуль транскрибации.
4. Результат транскрибации передаётся в модуль диаризации.
5. Модуль постобработки объединяет данные и формирует итоговый текст.
6. Модуль экспорта сохраняет результат в .txt.

## ASCII-схема 1: Поток обработки (end-to-end)

```
+--------------------+        +-------------------------+
|  Пользователь      |        |        GUI (PyQt)       |
|  drag-n-drop файл  +------->+  Старт пайплайна        |
+--------------------+        |  Статусы/ошибки         |
                              |  Путь к файлу           |
                              +-----------+-------------+
                                          |
                                          v
                              +-----------+-------------+
                              |  MediaProc (FFmpeg)     |
                              |  - Извлечение аудио     |
                              |  - Нормализация (PCM)   |
                              +-----------+-------------+
                                          |
                                          v
                              +-----------+-------------+
                              |  ASR (Whisper)          |
                              |  - Распознавание        |
                              |  - Таймкоды фраз        |
                              +-----------+-------------+
                                          |
                                          v
                              +-----------+-------------+
                              |  Diarization (pyannote) |
                              |  - Кластеры спикеров    |
                              |  - Таймсегменты         |
                              +-----------+-------------+
                                          |
                                          v
                              +-----------+-------------+
                              |  Postprocess            |
                              |  - Слияние ASR+диары    |
                              |  - Правила строк/имён   |
                              +-----------+-------------+
                                          |
                                          v
                              +-----------+-------------+
                              |  Export                 |
                              |  - .txt (UTF-8)         |
                              +-----------+-------------+
                                          |
                                          v
                              +-----------+-------------+
                              |  GUI Result             |
                              |  - Путь к файлу         |
                              |  - Готово/ошибки        |
                              +-------------------------+
```

## ASCII-схема 2: Границы модулей и контракты

```
+-------------------+         +-------------------+
|       GUI         |<------->|   App Orchestr.   |
|  (view/status)    |  events |  (use-cases)      |
+---------+---------+         +-----+-------------+
          |                         |
          | paths                   | DTOs
          v                         v
+---------+---------+         +-----+-------------+
|   MediaProc      |         |       ASR         |
|  ffmpeg wrapper  |         |  whisper wrapper  |
| in: path         |         | in: wav path      |
| out: wav path    |         | out: segments[]   |
+---------+---------+         +-----+-------------+
          |                         |
          | wav path                | segments[]
          v                         v
+---------+---------+         +-----+-------------+
|  Diarization     |         |   Postprocess     |
| pyannote wrapper |-------->| merge(ASR, diar)  |
| in: wav path     |        /| out: utterances[] |
| out: speakers[]  |-------/ +-----+-------------+
+---------+---------+                |
                                     | utterances[]
                                     v
                             +-------+---------+
|     Export      |
| .txt            |
| out: file path  |
                             +-------+---------+
                                     |
                                     v
                               +-----+------+
                               |   Logger   |
                               |  (file/ui) |
                               +------------+
```

## Дерево проекта

```
transcriber/
├─ app.py                    # точка входа (GUI + оркестрация)
├─ gui/
│  ├─ window.py              # окно, drag-n-drop, статусы
│  └─ messages.py            # тексты статусов/ошибок
├─ core/
│  ├─ orchestrator.py        # сценарии, пайплайн
│  ├─ media_proc.py          # FFmpeg-обёртка
│  ├─ asr_whisper.py         # ASR
│  ├─ diarization.py         # pyannote
│  ├─ postprocess.py         # слияние, правила строк
│  ├─ export_txt.py          # .txt
│  └─ models.py              # DTO: ASRSegment, DiarSeg, Utterance
├─ utils/
│  ├─ paths.py               # имена файлов/папок
│  ├─ timing.py              # форматирование таймкодов
│  └─ logging_setup.py       # лог-файл + консоль
├─ tests/
│  ├─ test_media_proc.py
│  ├─ test_asr_whisper.py
│  ├─ test_diarization.py
│  ├─ test_postprocess.py
│  └─ test_export.py
└─ requirements.txt
```
